<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŸºé‡‘æ ¸å¿ƒçœ‹æ¿ V7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .up { color: #ef4444; }
        .down { color: #22c55e; }
        .bg-up { background-color: #fef2f2; }
        .bg-down { background-color: #f0fdf4; }
        /* ç§»é™¤ç‚¹å‡»é«˜äº®èƒŒæ™¯ï¼Œä¿æŒæ¸…çˆ½ */
        .tap-transparent { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 antialiased">
    <div class="max-w-md mx-auto md:max-w-5xl min-h-screen pb-32 relative">
        
        <header class="bg-white/90 backdrop-blur-md border-b border-slate-200 sticky top-0 z-30 px-5 py-4 transition-all">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-bold text-slate-800 tracking-tight">æ ¸å¿ƒèµ„äº§ç›‘æ§</h1>
                <div class="flex items-center gap-2">
                     <span id="globalStatus" class="text-[10px] font-mono text-slate-400 bg-slate-100 px-2 py-1 rounded">å°±ç»ª</span>
                     <button onclick="refreshAll()" class="p-2 bg-slate-100 rounded-full active:rotate-180 transition duration-500">
                        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                     </button>
                </div>
            </div>

            <div class="flex gap-2">
                <input type="text" id="fundInput" inputmode="numeric" placeholder="è¾“å…¥åŸºé‡‘ä»£ç  (å¦‚ 000217)" 
                       class="flex-1 bg-slate-100 border-none px-4 py-3 rounded-xl outline-none text-base focus:ring-2 focus:ring-blue-500 transition-all">
                <button onclick="addNewFund()" class="bg-blue-600 text-white px-6 rounded-xl font-bold shadow-sm active:scale-95 transition">
                    æ·»åŠ 
                </button>
            </div>
        </header>

        <main class="p-4 md:p-6">
            <div id="fundListContainer" class="flex flex-col gap-3">
                </div>
            
            <div id="emptyState" class="hidden py-20 text-center">
                <div class="inline-block p-4 bg-slate-100 rounded-full mb-3">
                    <svg class="w-8 h-8 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </div>
                <p class="text-slate-400 text-sm">æš‚æ— èµ„äº§ï¼Œè¯·æ·»åŠ ä»£ç </p>
            </div>
        </main>

        <footer class="text-center text-[10px] text-slate-300 pb-8 px-8">
            <p>ç‚¹å‡»å¡ç‰‡å³ä¾§â€œğŸ”—â€å›¾æ ‡ç»‘å®š ETF ä»£ç ï¼Œä»¥è·å–ç²¾å‡†å®æ—¶ä¼°å€¼ã€‚</p>
        </footer>
    </div>

    <script>
        const STORAGE_KEY = 'my_fund_v7_db';
        // é¢„è®¾é…ç½®ï¼šåŒ…å«åŸºé‡‘ä»£ç å’Œï¼ˆå¯é€‰çš„ï¼‰å¯¹æ ‡ ETF ä»£ç 
        // 000217(åå®‰é»„é‡‘) -> sh518880(é»„é‡‘ETF)
        const DEFAULT_DB = [
            { code: '005562', proxy: '' },       // åˆ›é‡‘åˆä¿¡ (æ— å¯¹æ ‡ï¼Œç”¨é»˜è®¤ä¼°å€¼)
            { code: '000217', proxy: 'sh518880' } // åå®‰é»„é‡‘ (å¯¹æ ‡ é»„é‡‘ETF)
        ];

        let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || DEFAULT_DB;
        let cache = {}; // å†…å­˜ç¼“å­˜

        // --- æ ¸å¿ƒå¼•æ“ 1: é˜Ÿåˆ—åŠ è½½å™¨ (è§£å†³å‡€å€¼æ»å) ---
        // pingzhongdata æ˜¯é‡å‹ JSï¼ŒåŒ…å«å…¨å±€å˜é‡ Data_netWorthTrendã€‚
        // å¿…é¡»ä¸²è¡ŒåŠ è½½ï¼Œå¦åˆ™å˜é‡ä¼šå†²çªã€‚
        const NavLoader = {
            queue: [],
            isRunning: false,
            
            add(code) {
                this.queue.push(code);
                this.run();
            },

            run() {
                if (this.isRunning || this.queue.length === 0) return;
                this.isRunning = true;
                const code = this.queue.shift();
                
                updateStatus(`åŒæ­¥ ${code} å‡€å€¼...`);

                const script = document.createElement('script');
                // ä½¿ç”¨ https åè®®åŠ è½½å¤©å¤©åŸºé‡‘ K çº¿æ•°æ®
                script.src = `https://fund.eastmoney.com/pingzhongdata/${code}.js?t=${Date.now()}`;
                
                script.onload = () => {
                    // è¯»å–å…¨å±€å˜é‡ Data_netWorthTrend
                    if (window.Data_netWorthTrend && window.Data_netWorthTrend.length > 0) {
                        const last = window.Data_netWorthTrend[window.Data_netWorthTrend.length - 1];
                        // last ç»“æ„: {x: æ—¶é—´æˆ³, y: å‡€å€¼, equityReturn: æ¶¨å¹…, unitMoney: åˆ†çº¢}
                        // æ—¶é—´æˆ³è½¬æ¢
                        const dateObj = new Date(last.x);
                        const dateStr = `${(dateObj.getMonth()+1).toString().padStart(2,'0')}-${dateObj.getDate().toString().padStart(2,'0')}`;
                        
                        if (!cache[code]) cache[code] = {};
                        cache[code].nav = last.y;
                        cache[code].navDate = dateStr;
                        // åŒæ—¶è·å–ä¸€ä¸‹åŸºé‡‘åç§° (fS_name ä¹Ÿæ˜¯è¯¥æ–‡ä»¶çš„å…¨å±€å˜é‡)
                        if (window.fS_name) cache[code].name = window.fS_name;
                    }
                    // æ¸…ç†å…¨å±€å˜é‡ï¼Œé˜²æ­¢æ±¡æŸ“
                    window.Data_netWorthTrend = null;
                    window.fS_name = null;
                    
                    document.body.removeChild(script);
                    renderItem(code); // å±€éƒ¨åˆ·æ–°
                    this.isRunning = false;
                    this.run(); // ä¸‹ä¸€ä¸ª
                };

                script.onerror = () => {
                    console.error('Load failed:', code);
                    this.isRunning = false;
                    this.run();
                };

                document.body.appendChild(script);
            }
        };

        // --- æ ¸å¿ƒå¼•æ“ 2: å®æ—¶ä¼°å€¼ (æ”¯æŒ ETF å½±å­) ---
        function fetchRealTime(item) {
            // å¦‚æœé…ç½®äº† proxy (å¦‚ sh518880)ï¼Œåˆ™èµ°æ–°æµªè‚¡ç¥¨æ¥å£
            if (item.proxy) {
                const script = document.createElement('script');
                script.src = `https://hq.sinajs.cn/list=${item.proxy}`;
                script.charset = 'gbk';
                script.onload = () => {
                    // var hq_str_sh518880 = "..."
                    const varName = `hq_str_${item.proxy}`;
                    const dataStr = window[varName];
                    if (dataStr) {
                        const parts = dataStr.split(',');
                        // æ–°æµªè‚¡ç¥¨: 3=å½“å‰ä»·, 2=æ˜¨æ”¶
                        const current = parseFloat(parts[3]);
                        const yesterday = parseFloat(parts[2]);
                        let percent = 0;
                        if (yesterday > 0) {
                            percent = ((current - yesterday) / yesterday) * 100;
                        }

                        if (!cache[item.code]) cache[item.code] = {};
                        cache[item.code].proxyChange = percent.toFixed(2);
                        cache[item.code].proxyName = parts[0]; // è‚¡ç¥¨åç§°
                        renderItem(item.code);
                    }
                };
                document.body.appendChild(script);
            } 
            // å¦åˆ™èµ°å¤©å¤©åŸºé‡‘ä¼°å€¼ (fallback)
            else {
                const script = document.createElement('script');
                script.src = `https://fundgz.1234567.com.cn/js/${item.code}.js?rt=${Date.now()}`;
                script.onload = () => {
                    // jsonpgz callback is global, handled below
                };
                document.body.appendChild(script);
            }
        }

        // å¤©å¤©åŸºé‡‘å›è°ƒ
        window.jsonpgz = function(data) {
            if (!cache[data.fundcode]) cache[data.fundcode] = {};
            cache[data.fundcode].estChange = data.gszzl;
            cache[data.fundcode].estVal = data.gsz;
            // å¦‚æœ NavLoader è¿˜æ²¡è·‘å®Œï¼Œå…ˆç”¨è¿™ä¸ªåå­—
            if (!cache[data.fundcode].name) cache[data.fundcode].name = data.name;
            renderItem(data.fundcode);
        };


        // --- ä¸šåŠ¡é€»è¾‘ ---

        function refreshAll() {
            updateStatus('æ›´æ–°ä¸­...');
            db.forEach(item => {
                // 1. å¯åŠ¨å‡€å€¼åŠ è½½ (Kçº¿æ•°æ®)
                NavLoader.add(item.code);
                // 2. å¯åŠ¨å®æ—¶ä¼°å€¼ (ETF æˆ– ä¼°å€¼API)
                fetchRealTime(item);
            });
            setTimeout(() => updateStatus('ç›‘æ§ä¸­'), 3000);
        }

        function addNewFund() {
            const input = document.getElementById('fundInput');
            const code = input.value.trim();
            if (/^\d{6}$/.test(code)) {
                if (!db.find(i => i.code === code)) {
                    db.unshift({ code: code, proxy: '' }); // é»˜è®¤æ—  proxy
                    saveDb();
                    refreshAll();
                    renderList(); // é‡ç»˜ç»“æ„
                    input.value = '';
                } else { alert('å·²å­˜åœ¨'); }
            }
        }

        function removeFund(code) {
            if(confirm('åˆ é™¤æ­¤åŸºé‡‘ï¼Ÿ')) {
                db = db.filter(i => i.code !== code);
                saveDb();
                renderList();
            }
        }

        function bindProxy(code) {
            const item = db.find(i => i.code === code);
            const input = prompt(
                `ä¸º ${code} è®¾ç½®å®æ—¶å¯¹æ ‡ (å½±å­é”šç‚¹)\n\nè¯·è¾“å…¥åœºå†…ä»£ç  (å¦‚ é»„é‡‘ETF è¾“å…¥ sh518880)ã€‚\nè¾“å…¥ç©ºå€¼åˆ™æ¢å¤é»˜è®¤ä¼°å€¼ã€‚`, 
                item.proxy || ''
            );
            if (input !== null) {
                item.proxy = input.trim();
                saveDb();
                refreshAll();
            }
        }

        function saveDb() { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
        function updateStatus(msg) { document.getElementById('globalStatus').innerText = msg; }

        // --- æ¸²æŸ“é€»è¾‘ (æ— è¡¨æ ¼ï¼Œæ”¹ç”¨å¡ç‰‡æµ) ---

        function renderList() {
            const container = document.getElementById('fundListContainer');
            const empty = document.getElementById('emptyState');
            container.innerHTML = '';

            if (db.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            db.forEach(item => {
                // åˆ›å»ºå¡ç‰‡éª¨æ¶
                const div = document.createElement('div');
                div.id = `card-${item.code}`;
                div.className = "bg-white rounded-xl p-4 shadow-sm border border-slate-100 flex justify-between items-center tap-transparent";
                div.innerHTML = getCardHtml(item);
                container.appendChild(div);
            });
        }

        function renderItem(code) {
            const card = document.getElementById(`card-${code}`);
            const item = db.find(i => i.code === code);
            if (card && item) {
                card.innerHTML = getCardHtml(item);
            }
        }

        function getCardHtml(item) {
            const data = cache[item.code] || {};
            const name = data.name || item.code;
            
            // å‡€å€¼éƒ¨åˆ†
            const nav = data.nav || '--';
            const navDate = data.navDate || '--';

            // å®æ—¶éƒ¨åˆ†
            let realTimeHtml = '';
            
            if (item.proxy) {
                // èµ° ETF ä»£ç†
                const change = data.proxyChange || 0;
                const isUp = parseFloat(change) >= 0;
                const color = isUp ? 'text-red-500' : 'text-green-500';
                const bg = isUp ? 'bg-red-50' : 'bg-green-50';
                const sign = parseFloat(change) > 0 ? '+' : '';
                
                realTimeHtml = `
                    <div class="text-right">
                        <div class="text-lg font-bold font-mono ${color} leading-none mb-1">${sign}${change}%</div>
                        <div class="text-[10px] text-slate-400 font-medium bg-slate-100 px-1.5 py-0.5 rounded inline-block">
                            âš“ å¯¹æ ‡: ${item.proxy}
                        </div>
                    </div>
                `;
            } else {
                // èµ°æ™®é€šä¼°å€¼
                const change = data.estChange || 0;
                const val = data.estVal || '--';
                const isUp = parseFloat(change) >= 0;
                const color = isUp ? 'text-red-500' : 'text-green-500';
                const sign = parseFloat(change) > 0 ? '+' : '';

                realTimeHtml = `
                    <div class="text-right">
                        <div class="text-lg font-bold font-mono ${color} leading-none mb-1">${sign}${change}%</div>
                        <div class="text-[10px] text-slate-400">
                            ä¼° ${val}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="flex-1 min-w-0 pr-4">
                    <div class="text-sm font-bold text-slate-700 truncate mb-1">${name}</div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-mono text-slate-500 bg-slate-50 px-1.5 rounded border border-slate-100">${nav}</span>
                        <span class="text-[10px] text-slate-300">å·²ç¡®è®¤ ${navDate}</span>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    ${realTimeHtml}
                    
                    <div class="flex flex-col gap-2 pl-3 border-l border-slate-100">
                        <button onclick="bindProxy('${item.code}')" class="text-slate-300 hover:text-blue-500 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                        </button>
                        <button onclick="removeFund('${item.code}')" class="text-slate-300 hover:text-red-500 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            `;
        }

        // å¯åŠ¨
        renderList();
        refreshAll();
        // è‡ªåŠ¨åˆ·æ–° (9:00 - 15:00 æ¿€è¿›åˆ·æ–°ï¼Œå…¶ä»–æ—¶é—´æ…¢åˆ·æ–°ï¼Ÿæš‚å®šå…¨å±€30s)
        setInterval(refreshAll, 30000);

    </script>
</body>
</html>
