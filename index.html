<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>基金估值监控</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .up { color: #ef4444; }
        .down { color: #22c55e; }
        /* 针对移动端优化滚动条 */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 antialiased">
    <div class="max-w-md mx-auto md:max-w-4xl min-h-screen pb-20">
        <header class="bg-white border-b sticky top-0 z-10 px-4 py-4 md:px-8">
            <div class="flex flex-col gap-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-xl font-bold tracking-tight">基金估值</h1>
                    <span id="refreshStatus" class="text-[10px] bg-blue-50 text-blue-500 px-2 py-1 rounded-full font-medium">自动更新中</span>
                </div>
                
                <div class="flex gap-2">
                    <input type="number" id="fundInput" inputmode="numeric" placeholder="6位代码" 
                           class="flex-1 border border-gray-200 px-3 py-2 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-base">
                    <button onclick="addFund()" class="bg-blue-600 text-white px-5 py-2 rounded-xl font-medium active:scale-95 transition">添加</button>
                    <button onclick="fetchAll()" class="bg-gray-100 p-2 rounded-xl active:rotate-180 transition-transform duration-500">
                        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </button>
                </div>
            </div>
        </header>

        <main class="p-4">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-100">
                        <tr class="text-left text-xs text-gray-400 font-medium">
                            <th class="py-3 px-4">基金名称</th>
                            <th class="py-3 px-2 hidden md:table-cell">昨日净值</th>
                            <th class="py-3 px-2 text-right md:text-left">实时估值</th>
                            <th class="py-3 px-4 text-right">涨跌幅</th>
                            <th class="py-3 px-4 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="fund-table" class="divide-y divide-gray-50">
                        </tbody>
                </table>
                <div id="emptyState" class="hidden py-12 text-center text-gray-400 text-sm">
                    还没有添加基金，输入代码开始监控
                </div>
            </div>
        </main>

        <footer class="mt-4 px-6 text-center">
            <p class="text-[10px] text-gray-300 uppercase tracking-widest">Data by Eastmoney | Developed for You</p>
        </footer>
    </div>

    <script>
        const STORAGE_KEY = 'my_fund_list_v2';
        // 初始数据保留你感兴趣的红利低波和黄金
        let fundList = JSON.parse(localStorage.getItem(STORAGE_KEY)) || ['005562', '000217'];
        let results = {};

        window.jsonpgz = function(data) {
            results[data.fundcode] = data;
            renderTable();
        };

        function fetchFund(code) {
            const script = document.createElement('script');
            script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
            document.body.appendChild(script);
            document.body.removeChild(script);
        }

        function fetchAll() {
            if (fundList.length === 0) {
                renderTable();
                return;
            }
            fundList.forEach(code => fetchFund(code));
            const btn = document.getElementById('refreshStatus');
            btn.innerText = '更新完毕 ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function addFund() {
            const input = document.getElementById('fundInput');
            const code = input.value.trim();
            if (/^\d{6}$/.test(code)) {
                if (!fundList.includes(code)) {
                    fundList.unshift(code); // 新添加的放前面
                    saveAndRefresh();
                    input.value = '';
                    input.blur(); // 隐藏手机键盘
                }
            }
        }

        function removeFund(code) {
            fundList = fundList.filter(item => item !== code);
            delete results[code];
            saveAndRefresh();
        }

        function saveAndRefresh() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(fundList));
            fetchAll();
        }

        function renderTable() {
            const tbody = document.getElementById('fund-table');
            const empty = document.getElementById('emptyState');
            
            if (fundList.length === 0) {
                tbody.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');
            
            // 保持显示顺序与 fundList 一致
            const html = fundList.map(code => {
                const data = results[code];
                if (!data) return '';

                const isUp = parseFloat(data.gszzl) >= 0;
                return `
                    <tr class="active:bg-gray-50 transition-colors">
                        <td class="py-4 px-4">
                            <div class="text-sm font-bold text-gray-800 line-clamp-1">${data.name}</div>
                            <div class="text-[10px] text-gray-400 font-mono mt-0.5">${data.fundcode}</div>
                        </td>
                        <td class="py-4 px-2 hidden md:table-cell text-sm text-gray-500">${data.dwjz}</td>
                        <td class="py-4 px-2 text-right md:text-left">
                            <div class="text-sm font-bold ${isUp ? 'up' : 'down'}">${data.gsz}</div>
                            <div class="text-[10px] text-gray-400 md:hidden">${data.gztime.split(' ')[1]}</div>
                        </td>
                        <td class="py-4 px-4 text-right">
                            <span class="inline-block min-w-[60px] text-center px-2 py-1 rounded-lg text-xs font-bold ${isUp ? 'bg-red-50 up' : 'bg-green-50 down'}">
                                ${isUp ? '+' : ''}${data.gszzl}%
                            </span>
                        </td>
                        <td class="py-4 px-4 text-center">
                            <button onclick="removeFund('${data.fundcode}')" class="p-2 text-gray-300 hover:text-red-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = html;
        }

        // 初始化
        fetchAll();
        setInterval(fetchAll, 60000);
    </script>
</body>
</html>
