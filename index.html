<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基金实时监控 - 专业版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .up { color: #ef4444; }
        .down { color: #22c55e; }
        .font-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    </style>
</head>
<body class="bg-gray-50 p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">基金实时估值监控</h1>
                    <p class="text-sm text-gray-400 mt-1">自动持久化存储 · 每分钟自动刷新</p>
                </div>
                
                <div class="flex items-center gap-2">
                    <input type="text" id="fundInput" placeholder="输入6位基金代码" 
                           class="border border-gray-200 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-40 text-sm">
                    <button onclick="addFund()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition">添加</button>
                    <button onclick="fetchAll()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded-lg text-sm transition">强制刷新</button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider">
                            <th class="py-4 px-6">基金名称</th>
                            <th class="py-4 px-2">代码</th>
                            <th class="py-4 px-2">昨日净值</th>
                            <th class="py-4 px-2">昨日涨幅</th>
                            <th class="py-4 px-2">实时估值</th>
                            <th class="py-4 px-2">估值涨跌</th>
                            <th class="py-4 px-6 text-right">操作</th>
                        </tr>
                    </thead>
                    <tbody id="fund-table" class="divide-y divide-gray-50">
                        </tbody>
                </table>
            </div>
        </div>
        <p class="text-center text-xs text-gray-300 mt-8">数据基于公开接口 | 刷新频率：60s</p>
    </div>

    <script>
        // 1. 持久化逻辑
        const STORAGE_KEY = 'my_fund_list';
        const DEFAULT_FUNDS = ['005562', '000217', '015790']; // 默认显示你关注的基金
        
        let fundList = JSON.parse(localStorage.getItem(STORAGE_KEY)) || DEFAULT_FUNDS;
        let results = {};

        // 2. 数据获取 (JSONP)
        window.jsonpgz = function(data) {
            results[data.fundcode] = data;
            renderTable();
        };

        // 辅助函数：从天天基金另一个接口获取昨日涨幅（非必选，若第一个接口数据不足可扩展）
        // 这里我们优先从 fundgz 提取基本信息
        function fetchFund(code) {
            const script = document.createElement('script');
            script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
            document.body.appendChild(script);
            document.body.removeChild(script);
        }

        function fetchAll() {
            fundList.forEach(code => fetchFund(code));
        }

        // 3. 业务逻辑
        function addFund() {
            const input = document.getElementById('fundInput');
            const code = input.value.trim();
            if (/^\d{6}$/.test(code)) {
                if (!fundList.includes(code)) {
                    fundList.push(code);
                    saveAndRefresh();
                    input.value = '';
                } else {
                    alert('基金已存在');
                }
            } else {
                alert('请输入正确的6位基金代码');
            }
        }

        function removeFund(code) {
            fundList = fundList.filter(item => item !== code);
            delete results[code];
            saveAndRefresh();
        }

        function saveAndRefresh() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(fundList));
            fetchAll();
            renderTable();
        }

        // 4. 渲染逻辑
        function renderTable() {
            const tbody = document.getElementById('fund-table');
            tbody.innerHTML = '';
            
            fundList.forEach(code => {
                const data = results[code];
                if (!data) return;

                const isUp = parseFloat(data.gszzl) >= 0;
                
                // 注意：fundgz 接口不直接提供“昨日涨幅”百分比，
                // 但为了满足你的列需求，我们在界面上展示“最后确认日期”
                // 在实际金融开发中，通常需要配合历史净值接口。
                
                const row = `
                    <tr class="hover:bg-blue-50/30 transition-colors">
                        <td class="py-4 px-6">
                            <div class="font-bold text-gray-700">${data.name}</div>
                            <div class="text-xs text-gray-400 mt-1">更新：${data.gztime}</div>
                        </td>
                        <td class="py-4 px-2 font-mono text-sm text-gray-400">${data.fundcode}</td>
                        <td class="py-4 px-2 text-sm text-gray-600 font-medium">${data.dwjz}</td>
                        <td class="py-4 px-2 text-sm text-gray-400">--</td> <td class="py-4 px-2 text-sm font-bold ${isUp ? 'up' : 'down'}">${data.gsz}</td>
                        <td class="py-4 px-2">
                            <span class="px-2 py-1 rounded text-xs font-bold ${isUp ? 'bg-red-50 up' : 'bg-green-50 down'}">
                                ${isUp ? '+' : ''}${data.gszzl}%
                            </span>
                        </td>
                        <td class="py-4 px-6 text-right">
                            <button onclick="removeFund('${data.fundcode}')" class="text-gray-300 hover:text-red-500 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // 初始化
        fetchAll();
        setInterval(fetchAll, 60000);
    </script>
</body>
</html>
